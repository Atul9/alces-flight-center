

<div class='card'>
  <div class='card-header'>
    <ul class="nav">
      <li class="nav-item">
        <span class="navbar-brand">
          Overview
        </span>
      </li>
      <%= render 'cases/new_support_case_button', cluster: @cluster %>
    </ul>
  </div>

  <%= render 'clusters/details', cluster: @cluster %>
</div>

<div class='card'>
  <div class='card-header'>
    <ul class="nav">
      <li class="nav-item">
        <span class="navbar-brand">
          Maintenance
        </span>
      </li>
    </ul>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Date</th>
        <th>For</th>
        <th>Requested By</th>
        <th>Confirmed By</th>
      </tr>
    </thead>

    <tbody>
    <% @cluster.open_maintenance_windows.order(created_at: :desc).each do |window| %>
      <tr>
        <td><%= window.created_at.to_formatted_s(:short) %></td>
        <td><%= window.associated_model.decorate.links %></td>
        <td><%= window.user.name %></td>
        <td>
          <% if window.confirmed_by %>
            <%= window.confirmed_by.name %></td>
          <% else %>
            <%= button_to raw('Unconfirmed &mdash; click to confirm'),
              confirm_maintenance_window_path(window),
              class: ['btn', 'btn-success']
            %>
          <% end %>
      </tr>
    <% end %>
    </tbody>
  </table>
</div>

<div class='card'>
  <div class='card-header'>
    <ul class="nav">
      <li class="nav-item">
        <span class="navbar-brand">
          Documents
        </span>
      </li>
    </ul>
  </div>

  <ul class="list-group list-group-flush">
    <% @cluster.documents.each do |document| %>
      <li class="list-group-item">
        <%= link_to document.name, document.url, target: '_blank' %>
      </li>
    <% end %>
  </ul>
</div>

<div class='card'>
  <div class='card-header'>
    <ul class="nav">
      <li class="nav-item">
        <span class="navbar-brand">
          Services
        </span>
      </li>
    </ul>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Support type</th>
      </tr>
    </thead>

    <tbody>
    <% @cluster.services.each do |service| %>
      <tr>
        <td width='40%'>
          <%= link_to service.name, service_path(service) %>
          <%= service.under_maintenance_icon %>
        </td>
        <td width='30%'><%= service.readable_support_type.capitalize %></td>
        <% if current_user.admin? %>
          <td width='10%'>
            <%= link_to raw(icon 'wrench', interactive: true),
              new_service_maintenance_window_path(service),
              title: 'Start request for maintenance of this service'
            %>
          </td>
        <% end %>
        <td width='20%'>
          <%= service.change_support_type_button %>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>
</div>

<% @cluster.component_groups_by_type.each do |type| %>
  <div class='card'>
    <div class='card-header'>
      <ul class="nav">
        <li class="nav-item">
          <span class="navbar-brand">
            <%= type.name.pluralize %>
          </span>
        </li>
      </ul>
    </div>

    <div class='card-body'>
      <% type.component_groups.each do |group| %>
        <h6 class="card-title">
          <% group_size = group.components.length %>
          <%= group.name %> &mdash; <%= pluralize(group_size, group.component_type.name) %>
        </h6>

        <table class="table">

          <thead>
            <tr>
              <th>Name</th>
              <th>Support type</th>
              <th></th>
            </tr>
          </thead>

          <tbody>
            <% group.decorate.components.each do |component| %>
              <tr>
                <td width='40%'>
                  <%= link_to component.name, component_path(component) %>
                  <%= component.under_maintenance_icon %>
                </td>
                <td width='30%'>
                  <%= component.readable_support_type.capitalize %>
                </td>
                <td width='20%'>
                  <%= component.change_support_type_button %>
                </td>
              </tr>
            <% end %>
          </tbody>

        </table>
      <% end %>
    </div>

  </div>
<% end %>
