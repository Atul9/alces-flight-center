
<% manage_cases_page = current_user.admin? && archive %>

<div class='card'>
  <div class='card-header'>
    <ul class="nav">
      <li class="nav-item">
        <span class="navbar-brand">
          <%= archive ? 'All' : 'Open' %>
          support cases
        </span>
      </li>
      <% unless archive %>
        <li class="nav-item">
          <%= link_to 'View all',
            current_user.admin? ? site_cases_path(@site) : cases_path,
            class: ['nav-link', 'btn', 'btn-dark'],
            role: 'button'
          %>
        </li>
      <% end %>
      <%= render 'cases/new_support_case_button' %>
    </ul>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Creator</th>
        <th>Category</th>
        <th>Issue</th>
        <th>Cluster</th>
        <th>Association</th>
        <th>Details</th>
        <% if manage_cases_page %>
          <th>Ticket status</th>
        <% else %>
          <th>Contact support</th>
          <th>Archive<%= archive ? '/Restore' : '' %></th>
        <% end %>
      </tr>
    </thead>

    <tbody>
    <% cases.order(created_at: :desc).decorate.each do |c| %>
      <% if archive || c.open %>
        <% if c.archived && !manage_cases_page %>
          <tr
            class="archived-case-row"
            title="This support case has been archived; you should open a new support case if you wish to contact Alces Flight Support"
          >
        <% else %>
          <tr>
        <% end %>
          <td
            title="Support case created on <%= c.created_at.to_formatted_s(:long) %>"
          >
            <%= c.created_at.to_formatted_s(:short) %>
          </td>
          <td><%= c.user.name %></td>
          <td><%= c.case_category.name %></td>
          <td><%= c.issue.name %></td>
          <td><%= c.cluster.name %></td>
          <td><%= c.association_info %></td>
          <td><%= c.details %></td>
          <% if manage_cases_page %>
            <td>
              <%= link_to c.last_known_ticket_status, c.rt_ticket_url %>
            </td>
          <% else %>
            <td><%= render 'cases/email_support_icon', support_case: c %></td>
            <td><%= render 'cases/archive_icon', support_case: c %></td>
          <% end %>
        </tr>
      <% end %>
    <% end %>
    </tbody>
  </table>
</div>
